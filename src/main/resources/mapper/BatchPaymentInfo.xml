<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="BatchPaymentInfo" >
        <resultMap id="ibator_BaseResultMap" type="com.shin.pay.entity.BatchPaymentInfo" >
                <result column="id" property="id" jdbcType="BIGINT" />
                <result column="batchOrderId" property="batchOrderId" jdbcType="BIGINT" />
                <result column="batchOrderNo" property="batchOrderNo" jdbcType="VARCHAR" />
                <result column="merchantCode" property="merchantCode" jdbcType="VARCHAR" />
                <result column="busiTypeId" property="busiTypeId" jdbcType="VARCHAR" />
                <result column="payPriority" property="payPriority" jdbcType="VARCHAR" />
                <result column="currentPriority" property="currentPriority" jdbcType="VARCHAR" />
                <result column="orderTime" property="orderTime" jdbcType="TIMESTAMP" />
                <result column="status" property="status" jdbcType="SMALLINT" />
                <result column="transTypeId" property="transTypeId" jdbcType="VARCHAR" />
                <result column="batchAmount" property="batchAmount" jdbcType="DECIMAL" />
                <result column="reduceAmount" property="reduceAmount" jdbcType="DECIMAL" />
                <result column="shouldPayAmount" property="shouldPayAmount" jdbcType="DECIMAL" />
                <result column="userPayFeeAmount" property="userPayFeeAmount" jdbcType="DECIMAL" />
                <result column="successAmount" property="successAmount" jdbcType="DECIMAL" />
                <result column="payFailedAmount" property="payFailedAmount" jdbcType="DECIMAL" />
                <result column="rollBackAmount" property="rollBackAmount" jdbcType="DECIMAL" />
                <result column="createTime" property="createTime" jdbcType="TIMESTAMP" />
                <result column="updateTime" property="updateTime" jdbcType="TIMESTAMP" />
                <result column="qunar_trade_no" property="qunar_trade_no" jdbcType="VARCHAR" />
                <result column="paySequenceNo" property="paySequenceNo" jdbcType="VARCHAR"/>
        </resultMap>

        <sql id="base_select">
                SELECT
                id
                ,batchOrderId
                ,batchOrderNo
                ,merchantCode
                ,busiTypeId
                ,payPriority
                ,currentPriority
                ,orderTime
                ,status
                ,transTypeId
                ,batchAmount
                ,reduceAmount
                ,shouldPayAmount
                ,userPayFeeAmount
                ,successAmount
                ,payFailedAmount
                ,rollBackAmount
                ,createTime
                ,updateTime
                ,qunar_trade_no
                ,paySequenceNo
        </sql>

        <sql id="base_where">
                <where >
                        <if test="id!=null" >
                                id = #{id:BIGINT}
                        </if>
                        <if test="batchOrderId!=null" >
                                and batchOrderId = #{batchOrderId:BIGINT}
                        </if>
                        <if test="batchOrderNo!=null" >
                                and batchOrderNo = #{batchOrderNo:VARCHAR}
                        </if>
                        <if test="merchantCode!=null" >
                                and merchantCode = #{merchantCode:VARCHAR}
                        </if>
                        <if test="busiTypeId!=null" >
                                and busiTypeId = #{busiTypeId:VARCHAR}
                        </if>
                        <if test="payPriority!=null" >
                                and payPriority = #{payPriority:VARCHAR}
                        </if>
                        <if test="currentPriority!=null" >
                                and currentPriority = #{currentPriority:VARCHAR}
                        </if>
                        <if test="orderTime!=null" >
                                and orderTime = #{orderTime:TIMESTAMP}
                        </if>
                        <if test="status!=null" >
                                and status = #{status:SMALLINT}
                        </if>
                        <if test="transTypeId!=null" >
                                and transTypeId = #{transTypeId:VARCHAR}
                        </if>
                        <if test="batchAmount!=null" >
                                and batchAmount = #{batchAmount:DECIMAL}
                        </if>
                        <if test="reduceAmount!=null" >
                                and reduceAmount = #{reduceAmount:DECIMAL}
                        </if>
                        <if test="shouldPayAmount!=null" >
                                and shouldPayAmount = #{shouldPayAmount:DECIMAL}
                        </if>
                        <if test="userPayFeeAmount!=null" >
                                and userPayFeeAmount = #{userPayFeeAmount:DECIMAL}
                        </if>
                        <if test="successAmount!=null" >
                                and successAmount = #{successAmount:DECIMAL}
                        </if>
                        <if test="payFailedAmount!=null" >
                                and payFailedAmount = #{payFailedAmount:DECIMAL}
                        </if>
                        <if test="rollBackAmount!=null" >
                                and rollBackAmount = #{rollBackAmount:DECIMAL}
                        </if>
                        <if test="createTime!=null" >
                                and createTime = #{createTime:TIMESTAMP}
                        </if>
                        <if test="updateTime!=null" >
                                and updateTime = #{updateTime:TIMESTAMP}
                        </if>
                        <if test="qunar_trade_no!=null and qunar_trade_no!=''">
                                and qunar_trade_no = #{qunar_trade_no:VARCHAR}
                        </if>
                        <if test="paySequenceNo!=null and paySequenceNo!=''">
                                and paySequenceNo = #{paySequenceNo:VARCHAR}
                        </if>
                </where>
        </sql>

        <select id="ibator_selectBatchPaymentByPrimaryKey" resultMap="ibator_BaseResultMap" parameterType="java.util.Map" >
                <include refid="base_select"/>
                from ${tableName}
                where
                id = #{id:BIGINT}
        </select>


        <insert id="ibator_insertBatchPaymentBySelective" parameterType="com.qunar.pay.g2.core.payment.entity.BatchPayment"
                useGeneratedKeys="true" keyProperty="id">
                insert into ${tableName}
                <trim prefix="(" suffix=")" suffixOverrides="," >
                        <if test="id!=null" >
                                id ,
                        </if>
                        <if test="batchOrderId!=null" >
                                batchOrderId ,
                        </if>
                        <if test="batchOrderNo!=null" >
                                batchOrderNo ,
                        </if>
                        <if test="merchantCode!=null" >
                                merchantCode ,
                        </if>
                        <if test="busiTypeId!=null" >
                                busiTypeId ,
                        </if>
                        <if test="payPriority!=null" >
                                payPriority,
                        </if>
                        <if test="currentPriority!=null" >
                                currentPriority,
                        </if>
                        <if test="orderTime!=null" >
                                orderTime ,
                        </if>
                        <if test="status!=null" >
                                status ,
                        </if>
                        <if test="transTypeId!=null" >
                                transTypeId ,
                        </if>
                        <if test="batchAmount!=null" >
                                batchAmount ,
                        </if>
                        <if test="reduceAmount!=null" >
                                reduceAmount ,
                        </if>
                        <if test="shouldPayAmount!=null" >
                                shouldPayAmount ,
                        </if>
                        <if test="userPayFeeAmount!=null" >
                                userPayFeeAmount ,
                        </if>
                        <if test="successAmount!=null" >
                                successAmount ,
                        </if>
                        <if test="payFailedAmount!=null" >
                                payFailedAmount ,
                        </if>
                        <if test="rollBackAmount!=null" >
                                rollBackAmount ,
                        </if>
                        <if test="createTime!=null" >
                                createTime ,
                        </if>
                        <if test="updateTime!=null" >
                                updateTime ,
                        </if>
                        <if test="qunar_trade_no!=null">
                                qunar_trade_no,
                        </if>
                        <if test="paySequenceNo!=null">
                                paySequenceNo
                        </if>
                </trim>
                values
                <trim prefix="(" suffix=")" suffixOverrides="," >
                        <if test="id!=null" >
                                #{id:BIGINT},
                        </if>
                        <if test="batchOrderId!=null" >
                                #{batchOrderId:BIGINT},
                        </if>
                        <if test="batchOrderNo!=null" >
                                #{batchOrderNo:VARCHAR},
                        </if>
                        <if test="merchantCode!=null" >
                                #{merchantCode:VARCHAR},
                        </if>
                        <if test="busiTypeId!=null" >
                                #{busiTypeId:VARCHAR},
                        </if>
                        <if test="payPriority!=null" >
                                #{payPriority:VARCHAR},
                        </if>
                        <if test="currentPriority!=null" >
                                #{currentPriority:VARCHAR},
                        </if>
                        <if test="orderTime!=null" >
                                #{orderTime:TIMESTAMP},
                        </if>
                        <if test="status!=null" >
                                #{status:SMALLINT},
                        </if>
                        <if test="transTypeId!=null" >
                                #{transTypeId:VARCHAR},
                        </if>
                        <if test="batchAmount!=null" >
                                #{batchAmount:DECIMAL},
                        </if>
                        <if test="reduceAmount!=null" >
                                #{reduceAmount:DECIMAL},
                        </if>
                        <if test="shouldPayAmount!=null" >
                                #{shouldPayAmount:DECIMAL},
                        </if>
                        <if test="userPayFeeAmount!=null" >
                                #{userPayFeeAmount:DECIMAL},
                        </if>
                        <if test="successAmount!=null" >
                                #{successAmount:DECIMAL},
                        </if>
                        <if test="payFailedAmount!=null" >
                                #{payFailedAmount:DECIMAL},
                        </if>
                        <if test="rollBackAmount!=null" >
                                #{rollBackAmount:DECIMAL},
                        </if>
                        <if test="createTime!=null" >
                                #{createTime:TIMESTAMP},
                        </if>
                        <if test="updateTime!=null" >
                                #{updateTime:TIMESTAMP},
                        </if>
                        <if test="qunar_trade_no!=null">
                                #{qunar_trade_no:VARCHAR},
                        </if>
                        <if test="paySequenceNo!=null">
                                #{paySequenceNo:VARCHAR}
                        </if>
                </trim>
        </insert>
        <update id="ibator_updateBatchPaymentBySelectiveId" parameterType="com.qunar.pay.g2.core.payment.entity.BatchPayment" >
                update ${tableName}
                <set >
                        <if test="batchOrderId!=null" >
                                batchOrderId = #{batchOrderId:BIGINT},
                        </if>
                        <if test="batchOrderNo!=null" >
                                batchOrderNo = #{batchOrderNo:VARCHAR},
                        </if>
                        <if test="merchantCode!=null" >
                                merchantCode = #{merchantCode:VARCHAR},
                        </if>
                        <if test="busiTypeId!=null" >
                                busiTypeId = #{busiTypeId:VARCHAR},
                        </if>
                        <if test="payPriority!=null" >
                                payPriority = #{payPriority:VARCHAR},
                        </if>
                        <if test="currentPriority!=null" >
                                currentPriority = #{currentPriority:VARCHAR},
                        </if>
                        <if test="orderTime!=null" >
                                orderTime = #{orderTime:TIMESTAMP},
                        </if>
                        <if test="status!=null" >
                                status = #{status:SMALLINT},
                        </if>
                        <if test="transTypeId!=null" >
                                transTypeId = #{transTypeId:VARCHAR},
                        </if>
                        <if test="batchAmount!=null" >
                                batchAmount = #{batchAmount:DECIMAL},
                        </if>
                        <if test="reduceAmount!=null" >
                                reduceAmount = #{reduceAmount:DECIMAL},
                        </if>
                        <if test="shouldPayAmount!=null" >
                                shouldPayAmount = #{shouldPayAmount:DECIMAL},
                        </if>
                        <if test="userPayFeeAmount!=null" >
                                userPayFeeAmount = #{userPayFeeAmount:DECIMAL},
                        </if>
                        <if test="successAmount!=null" >
                                successAmount = #{successAmount:DECIMAL},
                        </if>
                        <if test="payFailedAmount!=null" >
                                payFailedAmount = #{payFailedAmount:DECIMAL},
                        </if>
                        <if test="rollBackAmount!=null" >
                                rollBackAmount = #{rollBackAmount:DECIMAL},
                        </if>
                        <if test="createTime!=null" >
                                createTime = #{createTime:TIMESTAMP},
                        </if>
                        <if test="updateTime!=null" >
                                updateTime = #{updateTime:TIMESTAMP},
                        </if>
                        <if test="qunar_trade_no!=null and qunar_trade_no!=''">
                                qunar_trade_no = #{qunar_trade_no:VARCHAR},
                        </if>
                        <if test="paySequenceNo!=null and paySequenceNo!=''">
                                paySequenceNo = #{paySequenceNo:VARCHAR}
                        </if>
                </set>
                where
                id = #{id:BIGINT}
        </update>

        <update id="ibator_updateCurrPriorityById" parameterType="java.util.Map" >
                update ${tableName}
                set
                currentPriority = #{priority:VARCHAR},updateTime=now()
                where
                id = #{id:BIGINT}
        </update>

        <select id="ibator_selectBatchPaymentById4update" resultMap="ibator_BaseResultMap" parameterType="java.util.Map" >
                <include refid="base_select"/>
                FROM ${tableName}
                where id = #{id:BIGINT} for update
        </select>

        <update id="ibator_updateBatchPaymentStatusByIdWithOldStatus" parameterType="java.util.Map" >
                update ${tableName}
                set
                status = #{status:SMALLINT},updateTime=now()
                where
                id = #{id:BIGINT}
                <if test="oldStatus!=null">
                        AND status IN
                        <foreach item="item" index="index" collection="oldStatus" open="(" separator="," close=")">
                                #{item}
                        </foreach>
                </if>
        </update>

        <select id="ibator_selectBatchPaymentByStatus4update" resultMap="ibator_BaseResultMap" parameterType="java.util.Map" >
                <include refid="base_select"/>
                FROM ${tableName}
                where id = #{id:BIGINT} and status= #{status} for update
        </select>

        <select id="ibator_selectBatchPaymentByBatchOrderId" resultMap="ibator_BaseResultMap" parameterType="java.util.Map" >
                <include refid="base_select"/>
                FROM ${tableName}
                where batchOrderId = #{batchOrderId:BIGINT}
        </select>

        <select id="ibator_selectBatchPaymentByBatchPaymentIdAndStatus" resultMap="ibator_BaseResultMap" parameterType="java.util.Map" >
                <include refid="base_select"/>
                FROM  ${tableName}
                where id = #{id:BIGINT} and status= #{status}
        </select>

        <select id="ibator_selectBatchPayment4quartz" resultMap="ibator_BaseResultMap" parameterType="java.util.Map" >
                <include refid="base_select"/>
                FROM ${tableName}
                where status= #{status} and updateTime between #{beginTime} and #{endTime} and reduceAmount>0 limit #{limit}
        </select>

        <select id="ibator_countSameBatchOrderIdSuccessNum" resultType="java.lang.Integer" parameterType="java.util.Map" >
                select count(*) from ${tableName}
                where status= #{status} and batchOrderId = #{batchOrderId:BIGINT}
        </select>
</mapper>